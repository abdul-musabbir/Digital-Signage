version: '3.8'

services:
    app:
        build: .
        ports:
            - '8000:8000'
        volumes:
            - './storage:/var/www/html/storage'
            - './bootstrap/cache:/var/www/html/bootstrap/cache'
        environment:
            # Core Laravel Configuration
            APP_NAME: '${APP_NAME:-Laravel}'
            APP_ENV: '${APP_ENV:-production}'
            APP_KEY: '${APP_KEY}'
            APP_DEBUG: '${APP_DEBUG:-false}'
            APP_TIMEZONE: '${APP_TIMEZONE:-UTC}'
            APP_URL: '${APP_URL:-http://localhost:8000}'
            APP_LOCALE: '${APP_LOCALE:-en}'
            APP_FALLBACK_LOCALE: '${APP_FALLBACK_LOCALE:-en}'
            APP_FAKER_LOCALE: '${APP_FAKER_LOCALE:-en_US}'

            # Database Configuration
            DB_CONNECTION: '${DB_CONNECTION:-mysql}'
            DB_HOST: 'mysql' # This matches the service name
            DB_PORT: '${DB_PORT:-3306}'
            DB_DATABASE: '${DB_DATABASE}'
            DB_USERNAME: '${DB_USERNAME}'
            DB_PASSWORD: '${DB_PASSWORD}'

            # Session Configuration
            SESSION_DRIVER: '${SESSION_DRIVER:-file}'
            SESSION_LIFETIME: '${SESSION_LIFETIME:-120}'
            SESSION_ENCRYPT: '${SESSION_ENCRYPT:-false}'
            SESSION_PATH: '${SESSION_PATH:-/}'
            SESSION_DOMAIN: '${SESSION_DOMAIN:-null}'

            # Cache Configuration
            CACHE_STORE: '${CACHE_STORE:-file}'
            CACHE_PREFIX: '${CACHE_PREFIX:-laravel_cache}'

            # Queue Configuration
            QUEUE_CONNECTION: '${QUEUE_CONNECTION:-database}'

            # File System
            FILESYSTEM_DISK: '${FILESYSTEM_DISK:-local}'

            # Logging
            LOG_CHANNEL: '${LOG_CHANNEL:-stack}'
            LOG_STACK: '${LOG_STACK:-single}'
            LOG_LEVEL: '${LOG_LEVEL:-error}'

            # Broadcasting
            BROADCAST_CONNECTION: '${BROADCAST_CONNECTION:-log}'

            # Mail Configuration
            MAIL_MAILER: '${MAIL_MAILER:-log}'
            MAIL_HOST: '${MAIL_HOST:-127.0.0.1}'
            MAIL_PORT: '${MAIL_PORT:-2525}'
            MAIL_USERNAME: '${MAIL_USERNAME:-null}'
            MAIL_PASSWORD: '${MAIL_PASSWORD:-null}'
            MAIL_ENCRYPTION: '${MAIL_ENCRYPTION:-null}'
            MAIL_FROM_ADDRESS: '${MAIL_FROM_ADDRESS:-hello@example.com}'
            MAIL_FROM_NAME: '${MAIL_FROM_NAME:-Laravel}'

            # Other
            BCRYPT_ROUNDS: '${BCRYPT_ROUNDS:-12}'
            VITE_APP_NAME: '${APP_NAME:-Laravel}'

        depends_on:
            mysql:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:8000/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

    worker:
        build: .
        command: ['sh', '-c', 'sleep 30 && php /var/www/html/artisan queue:work --sleep=3 --tries=3 --max-time=3600']
        volumes:
            - './storage:/var/www/html/storage'
            - './bootstrap/cache:/var/www/html/bootstrap/cache'
        environment:
            # Core Laravel Configuration
            APP_NAME: '${APP_NAME:-Laravel}'
            APP_ENV: '${APP_ENV:-production}'
            APP_KEY: '${APP_KEY}'
            APP_DEBUG: '${APP_DEBUG:-false}'
            APP_TIMEZONE: '${APP_TIMEZONE:-UTC}'
            APP_URL: '${APP_URL:-http://localhost:8000}'

            # Database Configuration
            DB_CONNECTION: '${DB_CONNECTION:-mysql}'
            DB_HOST: 'mysql'
            DB_PORT: '${DB_PORT:-3306}'
            DB_DATABASE: '${DB_DATABASE}'
            DB_USERNAME: '${DB_USERNAME}'
            DB_PASSWORD: '${DB_PASSWORD}'

            # Queue Configuration
            QUEUE_CONNECTION: '${QUEUE_CONNECTION:-database}'

            # Cache Configuration
            CACHE_STORE: '${CACHE_STORE:-file}'

            # Logging
            LOG_CHANNEL: '${LOG_CHANNEL:-stack}'
            LOG_LEVEL: '${LOG_LEVEL:-error}'

        depends_on:
            mysql:
                condition: service_healthy
            app:
                condition: service_healthy
        restart: unless-stopped

    mysql:
        image: mysql:8.0
        cap_add:
            - SYS_NICE
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: '${DB_ROOT_PASSWORD}'
            MYSQL_DATABASE: '${DB_DATABASE}'
            MYSQL_USER: '${DB_USERNAME}'
            MYSQL_PASSWORD: '${DB_PASSWORD}'
            MYSQL_ALLOW_EMPTY_PASSWORD: 'no'
        ports:
            - '3306:3306'
        volumes:
            - 'mysql-data:/var/lib/mysql'
        healthcheck:
            test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p${DB_ROOT_PASSWORD}']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        command: --default-authentication-plugin=mysql_native_password

volumes:
    mysql-data:
        driver: local
